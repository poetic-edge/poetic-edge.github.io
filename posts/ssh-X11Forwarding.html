<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>ssh X11 Forwarding机制浅析</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/3844249ad6a7a4ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3844249ad6a7a4ac.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a63752334c8e04a2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a63752334c8e04a2.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-779b41245c009d2a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-86ab1eeeb05633e8.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...nextmd%5D-1ce836a4efc08fc4.js" defer=""></script><script src="/_next/static/yCKsVa8bSkRsO7_CVotQJ/_buildManifest.js" defer=""></script><script src="/_next/static/yCKsVa8bSkRsO7_CVotQJ/_ssgManifest.js" defer=""></script><script src="/_next/static/yCKsVa8bSkRsO7_CVotQJ/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="crt_layout__Vfhrf" style="display:none"><label class="terminal-module_terminal__4qfYI crt-terminal" for="crt-command-line-input"><div class="overlay-module_overlay__zbWt1 crt-overlay"><div class="overlay-module_scanner__jkhjA crt-scanner"></div><div class="overlay-module_pixels__m5X6w crt-pixels"></div></div><div class="screen-effects-module_screenEffects__bNTzl crt-screen-effects"><div class="terminal-module_overflowContainer__p2duW crt-terminal__overflow-container"><div class="text-effects-module_textEffects__OWNjV crt-text-effects"><div class="crt-terminal__screen"><div class="crt-screen"></div></div><div class="crt-terminal__command-line"><div class="command-line-module_commandLine__lnMf6 crt-command-line"><span class="crt-command-line__prompt">&gt; </span><div class="command-line-module_inputWrap__OpY8r crt-command-line__input-wrapper"><input type="text" class="command-line-module_input__ZPwEm crt-command-line__input" id="crt-command-line-input" value=""/><div class="command-line-module_inputString__J1jZF crt-command-line__input-string"><span class="character-module_character__MzT4w character-module_characterSelected__axWlO crt-cursor-symbol crt-character"> </span></div></div></div></div></div></div></div></label></div><div class="index_terminal__PfNCw crt-terminal"><div class="index_overlay__4m7iO"><div class="index_scanner__20Mgh"></div><div class="index_pixels__fCM6G"></div></div><div class="index_screenEffects__jIxEJ crt-screen-effects"><div class="index_overflowContainer__Fayc3 crt-terminal__overflow-container"><div class="index_textEffects__bn_0t crt-text-effects"><div><h1 id="ssh-x11-forwarding机制浅析">ssh X11 Forwarding机制浅析</h1>
<p>ssh通常被用来进行字符运维，但其实ssh也可以进行图像传输，所谓图像传输，实际上是X11协议数据的转发。Linux上的Xserver和Xclient是可以分离的，Xserver是负责显示以及键盘鼠标的输入，Xclient负责程序的运行。当Xserver监听网络端口时，也可以直接通过socket进行通信。一般Xserver默认不允许直接网络传输，这时候就可以借助ssh通道进行显示。</p>
<h3 id="运行简易流程">运行简易流程</h3>
<h4 id="ssh发起请求">ssh发起请求</h4>
<p>ssh -X user@serverIP</p>
<h4 id="sshd初始化">sshd初始化</h4>
<p>为了更好的叙述，将sshd运行的机子称为服务端。该端同时运行Xclient。
sshd接受请求建立连接，并将本次ssh会话的DISPLAY指定为<code>hostname:10.0</code>，这里需要注意的是DISPLAY环境变量格式为<code>hostname:displaynumber.screennumber</code>,若hostname为空，则表示Xserver运行在本机，当以tcp连接时，displaynumber的值为实际连接的端口减去6000，即本次的监听端口为6010，而6010的监听者就是sshd程序。</p>
<h4 id="图形程序的运行">图形程序的运行</h4>
<p>在ssh会话中执行图形程序，ssh客户端本质上只负责输入和显示，程序的执行在sshd上，这在pstree查看sshd进程可以看到<code>sshd(822369)---bash(822539)---xclock(1014618)</code>。比如在这里我运行了xclock，父进程为bash。该程序与6010进行TCP通信，将X11协议数据发送到6010,sshd再将该数据放入ssh通道与ssh客户端进行通信。
详见openssh项目channels.c文件中<code>static void channel_post_x11_listener(struct ssh *ssh, Channel *c)</code>函数。</p>
<h4 id="ssh与xserver通信">ssh与Xserver通信</h4>
<p>ssh运行在客户端，该端同时运行Xserver.
ssh与Xserver建立连接，将ssh通道中的X11协议数据发送到Xserver。
详见openssh项目channels.c文件中<code>int x11_connect_display(struct ssh *ssh)</code>函数。</p>
<h4 id="流程图">流程图</h4>
<p>本质上就是进行对X11协议进行了代理转发<br>
<img src="/assets/sshforwarding.png" alt="sshforwarding.png"></p></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{"title":"ssh X11 Forwarding机制浅析","excerpt":"","environment":"Nextjs","coverImage":"","date":"2022-05-03","author":{"name":"一然","picture":""},"ogImage":{"url":""}},"markdown":"\n# ssh X11 Forwarding机制浅析\nssh通常被用来进行字符运维，但其实ssh也可以进行图像传输，所谓图像传输，实际上是X11协议数据的转发。Linux上的Xserver和Xclient是可以分离的，Xserver是负责显示以及键盘鼠标的输入，Xclient负责程序的运行。当Xserver监听网络端口时，也可以直接通过socket进行通信。一般Xserver默认不允许直接网络传输，这时候就可以借助ssh通道进行显示。  \n\n\n### 运行简易流程\n#### ssh发起请求\nssh -X user@serverIP  \n\n#### sshd初始化\n为了更好的叙述，将sshd运行的机子称为服务端。该端同时运行Xclient。\nsshd接受请求建立连接，并将本次ssh会话的DISPLAY指定为`hostname:10.0`，这里需要注意的是DISPLAY环境变量格式为`hostname:displaynumber.screennumber`,若hostname为空，则表示Xserver运行在本机，当以tcp连接时，displaynumber的值为实际连接的端口减去6000，即本次的监听端口为6010，而6010的监听者就是sshd程序。   \n\n#### 图形程序的运行\n在ssh会话中执行图形程序，ssh客户端本质上只负责输入和显示，程序的执行在sshd上，这在pstree查看sshd进程可以看到`sshd(822369)---bash(822539)---xclock(1014618)`。比如在这里我运行了xclock，父进程为bash。该程序与6010进行TCP通信，将X11协议数据发送到6010,sshd再将该数据放入ssh通道与ssh客户端进行通信。\n详见openssh项目channels.c文件中`static void channel_post_x11_listener(struct ssh *ssh, Channel *c)`函数。\n\n#### ssh与Xserver通信\nssh运行在客户端，该端同时运行Xserver.\nssh与Xserver建立连接，将ssh通道中的X11协议数据发送到Xserver。\n详见openssh项目channels.c文件中`int x11_connect_display(struct ssh *ssh)`函数。\n\n#### 流程图\n本质上就是进行对X11协议进行了代理转发   \n![sshforwarding.png](/assets/sshforwarding.png)","html":"\u003ch1 id=\"ssh-x11-forwarding机制浅析\"\u003essh X11 Forwarding机制浅析\u003c/h1\u003e\n\u003cp\u003essh通常被用来进行字符运维，但其实ssh也可以进行图像传输，所谓图像传输，实际上是X11协议数据的转发。Linux上的Xserver和Xclient是可以分离的，Xserver是负责显示以及键盘鼠标的输入，Xclient负责程序的运行。当Xserver监听网络端口时，也可以直接通过socket进行通信。一般Xserver默认不允许直接网络传输，这时候就可以借助ssh通道进行显示。\u003c/p\u003e\n\u003ch3 id=\"运行简易流程\"\u003e运行简易流程\u003c/h3\u003e\n\u003ch4 id=\"ssh发起请求\"\u003essh发起请求\u003c/h4\u003e\n\u003cp\u003essh -X user@serverIP\u003c/p\u003e\n\u003ch4 id=\"sshd初始化\"\u003esshd初始化\u003c/h4\u003e\n\u003cp\u003e为了更好的叙述，将sshd运行的机子称为服务端。该端同时运行Xclient。\nsshd接受请求建立连接，并将本次ssh会话的DISPLAY指定为\u003ccode\u003ehostname:10.0\u003c/code\u003e，这里需要注意的是DISPLAY环境变量格式为\u003ccode\u003ehostname:displaynumber.screennumber\u003c/code\u003e,若hostname为空，则表示Xserver运行在本机，当以tcp连接时，displaynumber的值为实际连接的端口减去6000，即本次的监听端口为6010，而6010的监听者就是sshd程序。\u003c/p\u003e\n\u003ch4 id=\"图形程序的运行\"\u003e图形程序的运行\u003c/h4\u003e\n\u003cp\u003e在ssh会话中执行图形程序，ssh客户端本质上只负责输入和显示，程序的执行在sshd上，这在pstree查看sshd进程可以看到\u003ccode\u003esshd(822369)---bash(822539)---xclock(1014618)\u003c/code\u003e。比如在这里我运行了xclock，父进程为bash。该程序与6010进行TCP通信，将X11协议数据发送到6010,sshd再将该数据放入ssh通道与ssh客户端进行通信。\n详见openssh项目channels.c文件中\u003ccode\u003estatic void channel_post_x11_listener(struct ssh *ssh, Channel *c)\u003c/code\u003e函数。\u003c/p\u003e\n\u003ch4 id=\"ssh与xserver通信\"\u003essh与Xserver通信\u003c/h4\u003e\n\u003cp\u003essh运行在客户端，该端同时运行Xserver.\nssh与Xserver建立连接，将ssh通道中的X11协议数据发送到Xserver。\n详见openssh项目channels.c文件中\u003ccode\u003eint x11_connect_display(struct ssh *ssh)\u003c/code\u003e函数。\u003c/p\u003e\n\u003ch4 id=\"流程图\"\u003e流程图\u003c/h4\u003e\n\u003cp\u003e本质上就是进行对X11协议进行了代理转发\u003cbr\u003e\n\u003cimg src=\"/assets/sshforwarding.png\" alt=\"sshforwarding.png\"\u003e\u003c/p\u003e","mdxSource":null,"tableOfContents":[{"text":"ssh X11 Forwarding机制浅析","id":"ssh-x11-forwarding机制浅析","level":1,"subItems":[{"text":"运行简易流程","id":"运行简易流程","level":3,"subItems":[{"text":"ssh发起请求","id":"ssh发起请求","level":4,"subItems":[]},{"text":"sshd初始化","id":"sshd初始化","level":4,"subItems":[]},{"text":"图形程序的运行","id":"图形程序的运行","level":4,"subItems":[]},{"text":"ssh与Xserver通信","id":"ssh与xserver通信","level":4,"subItems":[]},{"text":"流程图","id":"流程图","level":4,"subItems":[]}]}]}],"nextmd":["posts","ssh-X11Forwarding"],"subPaths":[]},"__N_SSG":true},"page":"/[...nextmd]","query":{"nextmd":["posts","ssh-X11Forwarding"]},"buildId":"yCKsVa8bSkRsO7_CVotQJ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>