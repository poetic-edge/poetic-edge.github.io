<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/3844249ad6a7a4ac.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3844249ad6a7a4ac.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-779b41245c009d2a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-86ab1eeeb05633e8.js" defer=""></script><script src="/_next/static/chunks/pages/index-35b49a9d4f0077e2.js" defer=""></script><script src="/_next/static/yCKsVa8bSkRsO7_CVotQJ/_buildManifest.js" defer=""></script><script src="/_next/static/yCKsVa8bSkRsO7_CVotQJ/_ssgManifest.js" defer=""></script><script src="/_next/static/yCKsVa8bSkRsO7_CVotQJ/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="crt_layout__Vfhrf" style="display:block"><label class="terminal-module_terminal__4qfYI crt-terminal" for="crt-command-line-input"><div class="overlay-module_overlay__zbWt1 crt-overlay"><div class="overlay-module_scanner__jkhjA crt-scanner"></div><div class="overlay-module_pixels__m5X6w crt-pixels"></div></div><div class="screen-effects-module_screenEffects__bNTzl crt-screen-effects"><div class="terminal-module_overflowContainer__p2duW crt-terminal__overflow-container"><div class="text-effects-module_textEffects__OWNjV crt-text-effects"><div class="crt-terminal__screen"><div class="crt-screen"></div></div><div class="crt-terminal__command-line"><div class="command-line-module_commandLine__lnMf6 crt-command-line"><span class="crt-command-line__prompt">&gt; </span><div class="command-line-module_inputWrap__OpY8r crt-command-line__input-wrapper"><input type="text" class="command-line-module_input__ZPwEm crt-command-line__input" id="crt-command-line-input" value=""/><div class="command-line-module_inputString__J1jZF crt-command-line__input-string"><span class="character-module_character__MzT4w character-module_characterSelected__axWlO crt-cursor-symbol crt-character"> </span></div></div></div></div></div></div></div></label></div><div style="display:none"></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontMatter":{},"markdown":"","html":"","mdxSource":null,"tableOfContents":[],"nextmd":["posts"],"subPaths":[{"nextmd":["posts","ssh-X11Forwarding"],"frontMatter":{"title":"ssh X11 Forwarding机制浅析","excerpt":"","environment":"Nextjs","coverImage":"","date":"2022-05-03","author":{"name":"一然","picture":""},"ogImage":{"url":""}},"markdown":"\n# ssh X11 Forwarding机制浅析\nssh通常被用来进行字符运维，但其实ssh也可以进行图像传输，所谓图像传输，实际上是X11协议数据的转发。Linux上的Xserver和Xclient是可以分离的，Xserver是负责显示以及键盘鼠标的输入，Xclient负责程序的运行。当Xserver监听网络端口时，也可以直接通过socket进行通信。一般Xserver默认不允许直接网络传输，这时候就可以借助ssh通道进行显示。  \n\n\n### 运行简易流程\n#### ssh发起请求\nssh -X user@serverIP  \n\n#### sshd初始化\n为了更好的叙述，将sshd运行的机子称为服务端。该端同时运行Xclient。\nsshd接受请求建立连接，并将本次ssh会话的DISPLAY指定为`hostname:10.0`，这里需要注意的是DISPLAY环境变量格式为`hostname:displaynumber.screennumber`,若hostname为空，则表示Xserver运行在本机，当以tcp连接时，displaynumber的值为实际连接的端口减去6000，即本次的监听端口为6010，而6010的监听者就是sshd程序。   \n\n#### 图形程序的运行\n在ssh会话中执行图形程序，ssh客户端本质上只负责输入和显示，程序的执行在sshd上，这在pstree查看sshd进程可以看到`sshd(822369)---bash(822539)---xclock(1014618)`。比如在这里我运行了xclock，父进程为bash。该程序与6010进行TCP通信，将X11协议数据发送到6010,sshd再将该数据放入ssh通道与ssh客户端进行通信。\n详见openssh项目channels.c文件中`static void channel_post_x11_listener(struct ssh *ssh, Channel *c)`函数。\n\n#### ssh与Xserver通信\nssh运行在客户端，该端同时运行Xserver.\nssh与Xserver建立连接，将ssh通道中的X11协议数据发送到Xserver。\n详见openssh项目channels.c文件中`int x11_connect_display(struct ssh *ssh)`函数。\n\n#### 流程图\n本质上就是进行对X11协议进行了代理转发   \n![sshforwarding.png](/assets/sshforwarding.png)"}]},"__N_SSG":true},"page":"/","query":{},"buildId":"yCKsVa8bSkRsO7_CVotQJ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>